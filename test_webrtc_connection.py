#!/usr/bin/env python3\n\"\"\"\nWebRTCè¿æ¥ç¨³å®šæ€§æµ‹è¯•è„šæœ¬\næµ‹è¯•ä¿®å¤åçš„WebRTCè¿æ¥æ˜¯å¦ç¨³å®š\n\"\"\"\nimport asyncio\nimport aiohttp\nimport json\nimport time\nfrom datetime import datetime\n\nclass WebRTCConnectionTester:\n    def __init__(self, base_url=\"http://localhost:8010\"):\n        self.base_url = base_url\n        self.session = None\n        self.test_results = []\n    \n    async def __aenter__(self):\n        self.session = aiohttp.ClientSession()\n        return self\n    \n    async def __aexit__(self, exc_type, exc_val, exc_tb):\n        if self.session:\n            await self.session.close()\n    \n    def log_result(self, test_name, success, message=\"\", duration=0):\n        \"\"\"è®°å½•æµ‹è¯•ç»“æœ\"\"\"\n        result = {\n            'test': test_name,\n            'success': success,\n            'message': message,\n            'duration': duration,\n            'timestamp': datetime.now().isoformat()\n        }\n        self.test_results.append(result)\n        \n        status = \"âœ…\" if success else \"âŒ\"\n        print(f\"{status} {test_name}: {message} ({duration:.2f}s)\")\n    \n    async def test_server_health(self):\n        \"\"\"æµ‹è¯•æœåŠ¡å™¨å¥åº·çŠ¶æ€\"\"\"\n        start_time = time.time()\n        try:\n            async with self.session.get(f\"{self.base_url}/\") as response:\n                success = response.status == 200\n                duration = time.time() - start_time\n                self.log_result(\n                    \"æœåŠ¡å™¨å¥åº·æ£€æŸ¥\", \n                    success, \n                    f\"çŠ¶æ€ç : {response.status}\", \n                    duration\n                )\n                return success\n        except Exception as e:\n            duration = time.time() - start_time\n            self.log_result(\"æœåŠ¡å™¨å¥åº·æ£€æŸ¥\", False, f\"è¿æ¥å¤±è´¥: {e}\", duration)\n            return False\n    \n    async def test_webrtc_offer(self):\n        \"\"\"æµ‹è¯•WebRTC offerç«¯ç‚¹\"\"\"\n        start_time = time.time()\n        try:\n            # æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„WebRTC offer\n            offer_data = {\n                \"sdp\": \"v=0\\r\\no=- 123456789 2 IN IP4 127.0.0.1\\r\\ns=-\\r\\nt=0 0\\r\\na=group:BUNDLE 0 1\\r\\na=extmap-allow-mixed\\r\\na=msid-semantic: WMS\\r\\nm=video 9 UDP/TLS/RTP/SAVPF 96\\r\\nc=IN IP4 0.0.0.0\\r\\na=rtcp:9 IN IP4 0.0.0.0\\r\\na=ice-ufrag:test\\r\\na=ice-pwd:test\\r\\na=ice-options:trickle\\r\\na=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00\\r\\na=setup:actpass\\r\\na=mid:0\\r\\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\\r\\na=recvonly\\r\\na=rtcp-mux\\r\\na=rtpmap:96 VP8/90000\\r\\nm=audio 9 UDP/TLS/RTP/SAVPF 111\\r\\nc=IN IP4 0.0.0.0\\r\\na=rtcp:9 IN IP4 0.0.0.0\\r\\na=ice-ufrag:test\\r\\na=ice-pwd:test\\r\\na=ice-options:trickle\\r\\na=fingerprint:sha-256 00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00:00\\r\\na=setup:actpass\\r\\na=mid:1\\r\\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\\r\\na=recvonly\\r\\na=rtcp-mux\\r\\na=rtpmap:111 opus/48000/2\\r\\n\",\n                \"type\": \"offer\"\n            }\n            \n            async with self.session.post(\n                f\"{self.base_url}/offer\",\n                json=offer_data,\n                headers={'Content-Type': 'application/json'},\n                timeout=15  # å¢åŠ è¶…æ—¶æ—¶é—´\n            ) as response:\n                duration = time.time() - start_time\n                \n                if response.status == 200:\n                    data = await response.json()\n                    if 'sessionid' in data:\n                        self.log_result(\n                            \"WebRTC Offer\", \n                            True, \n                            f\"ä¼šè¯ID: {data['sessionid']}\", \n                            duration\n                        )\n                        return data['sessionid']\n                    else:\n                        self.log_result(\"WebRTC Offer\", False, \"å“åº”ä¸­ç¼ºå°‘sessionid\", duration)\n                        return None\n                else:\n                    error_text = await response.text()\n                    self.log_result(\n                        \"WebRTC Offer\", \n                        False, \n                        f\"çŠ¶æ€ç : {response.status}, é”™è¯¯: {error_text[:100]}\", \n                        duration\n                    )\n                    return None\n                    \n        except asyncio.TimeoutError:\n            duration = time.time() - start_time\n            self.log_result(\"WebRTC Offer\", False, \"è¯·æ±‚è¶…æ—¶\", duration)\n            return None\n        except Exception as e:\n            duration = time.time() - start_time\n            self.log_result(\"WebRTC Offer\", False, f\"å¼‚å¸¸: {e}\", duration)\n            return None\n    \n    async def test_session_heartbeat(self, session_id):\n        \"\"\"æµ‹è¯•ä¼šè¯å¿ƒè·³\"\"\"\n        if not session_id:\n            self.log_result(\"ä¼šè¯å¿ƒè·³\", False, \"æ— æœ‰æ•ˆä¼šè¯ID\")\n            return False\n        \n        start_time = time.time()\n        try:\n            heartbeat_data = {\"sessionid\": int(session_id)}\n            \n            async with self.session.post(\n                f\"{self.base_url}/session/heartbeat\",\n                json=heartbeat_data,\n                headers={'Content-Type': 'application/json'},\n                timeout=10\n            ) as response:\n                duration = time.time() - start_time\n                \n                if response.status == 200:\n                    data = await response.json()\n                    ttl = data.get('ttl_seconds', 'N/A')\n                    self.log_result(\n                        \"ä¼šè¯å¿ƒè·³\", \n                        True, \n                        f\"TTL: {ttl}ç§’\", \n                        duration\n                    )\n                    return True\n                else:\n                    error_text = await response.text()\n                    self.log_result(\n                        \"ä¼šè¯å¿ƒè·³\", \n                        False, \n                        f\"çŠ¶æ€ç : {response.status}, é”™è¯¯: {error_text[:100]}\", \n                        duration\n                    )\n                    return False\n                    \n        except Exception as e:\n            duration = time.time() - start_time\n            self.log_result(\"ä¼šè¯å¿ƒè·³\", False, f\"å¼‚å¸¸: {e}\", duration)\n            return False\n    \n    async def test_session_persistence(self, session_id):\n        \"\"\"æµ‹è¯•ä¼šè¯æŒä¹…æ€§\"\"\"\n        if not session_id:\n            self.log_result(\"ä¼šè¯æŒä¹…æ€§\", False, \"æ— æœ‰æ•ˆä¼šè¯ID\")\n            return False\n        \n        print(f\"\\næµ‹è¯•ä¼šè¯ {session_id} çš„æŒä¹…æ€§...\")\n        \n        # è¿ç»­å‘é€å¤šæ¬¡å¿ƒè·³ï¼Œæµ‹è¯•ä¼šè¯æ˜¯å¦ç¨³å®š\n        success_count = 0\n        total_tests = 5\n        \n        for i in range(total_tests):\n            print(f\"  å¿ƒè·³æµ‹è¯• {i+1}/{total_tests}\")\n            if await self.test_session_heartbeat(session_id):\n                success_count += 1\n            \n            # ç­‰å¾…ä¸€æ®µæ—¶é—´å†å‘é€ä¸‹ä¸€æ¬¡å¿ƒè·³\n            await asyncio.sleep(2)\n        \n        success_rate = (success_count / total_tests) * 100\n        success = success_rate >= 80  # 80%æˆåŠŸç‡è®¤ä¸ºæ˜¯ç¨³å®šçš„\n        \n        self.log_result(\n            \"ä¼šè¯æŒä¹…æ€§\", \n            success, \n            f\"æˆåŠŸç‡: {success_rate:.1f}% ({success_count}/{total_tests})\"\n        )\n        \n        return success\n    \n    async def test_connection_stability(self):\n        \"\"\"æµ‹è¯•è¿æ¥ç¨³å®šæ€§\"\"\"\n        print(\"\\nğŸ”— æµ‹è¯•WebRTCè¿æ¥ç¨³å®šæ€§...\")\n        \n        # åˆ›å»ºå¤šä¸ªä¼šè¯æµ‹è¯•å¹¶å‘ç¨³å®šæ€§\n        session_ids = []\n        \n        for i in range(3):  # åˆ›å»º3ä¸ªä¼šè¯\n            print(f\"\\nåˆ›å»ºä¼šè¯ {i+1}/3\")\n            session_id = await self.test_webrtc_offer()\n            if session_id:\n                session_ids.append(session_id)\n                await asyncio.sleep(1)  # é—´éš”1ç§’\n        \n        if not session_ids:\n            self.log_result(\"è¿æ¥ç¨³å®šæ€§\", False, \"æ— æ³•åˆ›å»ºä»»ä½•ä¼šè¯\")\n            return False\n        \n        # æµ‹è¯•æ‰€æœ‰ä¼šè¯çš„å¿ƒè·³\n        stable_sessions = 0\n        for session_id in session_ids:\n            if await self.test_session_heartbeat(session_id):\n                stable_sessions += 1\n        \n        stability_rate = (stable_sessions / len(session_ids)) * 100\n        success = stability_rate >= 80\n        \n        self.log_result(\n            \"è¿æ¥ç¨³å®šæ€§\", \n            success, \n            f\"ç¨³å®šä¼šè¯: {stable_sessions}/{len(session_ids)} ({stability_rate:.1f}%)\"\n        )\n        \n        # æ¸…ç†ä¼šè¯\n        for session_id in session_ids:\n            try:\n                await self.session.post(\n                    f\"{self.base_url}/session/close\",\n                    json={\"sessionid\": int(session_id)},\n                    headers={'Content-Type': 'application/json'},\n                    timeout=5\n                )\n            except:\n                pass  # å¿½ç•¥æ¸…ç†é”™è¯¯\n        \n        return success\n    \n    async def run_full_test(self):\n        \"\"\"è¿è¡Œå®Œæ•´çš„è¿æ¥ç¨³å®šæ€§æµ‹è¯•\"\"\"\n        print(f\"ğŸ§ª WebRTCè¿æ¥ç¨³å®šæ€§æµ‹è¯• - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\")\n        print(\"=\" * 70)\n        \n        # 1. æœåŠ¡å™¨å¥åº·æ£€æŸ¥\n        if not await self.test_server_health():\n            print(\"âŒ æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œç»ˆæ­¢æµ‹è¯•\")\n            return False\n        \n        # 2. åŸºæœ¬WebRTCè¿æ¥æµ‹è¯•\n        session_id = await self.test_webrtc_offer()\n        if not session_id:\n            print(\"âŒ æ— æ³•å»ºç«‹WebRTCè¿æ¥ï¼Œç»ˆæ­¢æµ‹è¯•\")\n            return False\n        \n        # 3. ä¼šè¯å¿ƒè·³æµ‹è¯•\n        await self.test_session_heartbeat(session_id)\n        \n        # 4. ä¼šè¯æŒä¹…æ€§æµ‹è¯•\n        await self.test_session_persistence(session_id)\n        \n        # 5. è¿æ¥ç¨³å®šæ€§æµ‹è¯•\n        await self.test_connection_stability()\n        \n        # æ¸…ç†æµ‹è¯•ä¼šè¯\n        try:\n            await self.session.post(\n                f\"{self.base_url}/session/close\",\n                json={\"sessionid\": int(session_id)},\n                headers={'Content-Type': 'application/json'},\n                timeout=5\n            )\n            print(f\"\\nğŸ§¹ æµ‹è¯•ä¼šè¯ {session_id} å·²æ¸…ç†\")\n        except:\n            pass\n        \n        # ç»Ÿè®¡ç»“æœ\n        total_tests = len(self.test_results)\n        passed_tests = sum(1 for r in self.test_results if r['success'])\n        \n        print(\"\\n\" + \"=\" * 70)\n        print(f\"ğŸ“Š æµ‹è¯•ç»“æœ: {passed_tests}/{total_tests} é€šè¿‡\")\n        \n        if passed_tests == total_tests:\n            print(\"ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼WebRTCè¿æ¥ç¨³å®š\")\n        else:\n            print(\"âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¿æ¥å¯èƒ½ä¸ç¨³å®š\")\n            \n            # æ˜¾ç¤ºå¤±è´¥çš„æµ‹è¯•\n            failed_tests = [r for r in self.test_results if not r['success']]\n            if failed_tests:\n                print(\"\\nâŒ å¤±è´¥çš„æµ‹è¯•:\")\n                for test in failed_tests:\n                    print(f\"   - {test['test']}: {test['message']}\")\n        \n        # è®¡ç®—ç¨³å®šæ€§è¯„åˆ†\n        stability_score = (passed_tests / total_tests) * 100\n        print(f\"\\nğŸ“ˆ è¿æ¥ç¨³å®šæ€§è¯„åˆ†: {stability_score:.1f}%\")\n        \n        if stability_score >= 90:\n            print(\"ğŸŒŸ è¿æ¥ç¨³å®šæ€§: ä¼˜ç§€\")\n        elif stability_score >= 80:\n            print(\"ğŸ‘ è¿æ¥ç¨³å®šæ€§: è‰¯å¥½\")\n        elif stability_score >= 70:\n            print(\"âš ï¸ è¿æ¥ç¨³å®šæ€§: ä¸€èˆ¬\")\n        else:\n            print(\"âŒ è¿æ¥ç¨³å®šæ€§: éœ€è¦æ”¹è¿›\")\n        \n        return passed_tests == total_tests\n\nasync def main():\n    \"\"\"ä¸»å‡½æ•°\"\"\"\n    import sys\n    \n    base_url = \"http://localhost:8010\"\n    if len(sys.argv) > 1:\n        base_url = sys.argv[1]\n    \n    print(f\"æµ‹è¯•æœåŠ¡å™¨: {base_url}\")\n    print(\"æç¤º: å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šæœåŠ¡å™¨åœ°å€\\n\")\n    \n    async with WebRTCConnectionTester(base_url) as tester:\n        success = await tester.run_full_test()\n        return 0 if success else 1\n\nif __name__ == \"__main__\":\n    try:\n        exit_code = asyncio.run(main())\n        exit(exit_code)\n    except KeyboardInterrupt:\n        print(\"\\næµ‹è¯•è¢«ä¸­æ–­\")\n        exit(1)\n    except Exception as e:\n        print(f\"æµ‹è¯•å¼‚å¸¸: {e}\")\n        exit(1)\n"