<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数字人 RAG 交互平台</title>
    <script src="client.js"></script>
    <style>
        :root {
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --primary-color: #1a73e8;
            --primary-hover: #1867cf;
            --text-color: #202124;
            --subtle-text: #5f6368;
            --border-color: #dadce0;
            --success-color: #1e8e3e;
            --error-color: #d93025;
            --font-family: 'Google Sans', 'Noto Sans SC', 'Roboto', 'Helvetica Neue', sans-serif;
            --border-radius: 8px;
            --shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
        }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 24px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
        }
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        h2, h3 {
            margin: 0;
            font-weight: 500;
        }
        h2 { font-size: 22px; }
        h3 { font-size: 18px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; }

        .video-container {
            background-color: #000;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }
        /* 直接对目标 video 元素进行样式设置 */
        #video {
            width: 100%;
            display: block;
        }

        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button {
            font-family: var(--font-family);
            padding: 10px 16px;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:not(:disabled):hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border-color: var(--border-color); }
        .btn-secondary:not(:disabled):hover { background-color: rgba(26, 115, 232, 0.05); }
        .btn-danger { background-color: var(--error-color); color: white; }
        .btn-danger:not(:disabled):hover { background-color: #a52714; }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 14px; font-weight: 500; color: var(--subtle-text); }
        input[type="text"], input[type="file"], select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            font-size: 14px;
            box-sizing: border-box;
        }
        input[type="file"] { padding: 5px; }
        textarea { resize: vertical; min-height: 80px; }
        
        .switch-container { display: flex; align-items: center; justify-content: space-between; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .chat-area { flex-grow: 1; display: flex; flex-direction: column; gap: 16px; }
        #chat-output {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px;
            min-height: 150px;
            flex-grow: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.6;
        }
        .status-bar {
            font-size: 12px; color: var(--subtle-text); padding: 8px; border-radius: var(--border-radius); background-color: var(--bg-color);
        }
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: var(--border-radius); color: white; font-weight: 500; z-index: 1000;
            opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateY(-20px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }
    </style>
</head>
<body>
    <input id="use-stun" type="checkbox" style="display: none;" checked>
    <input type="hidden" id="sessionid">
    
    <audio id="audio" autoplay></audio>

    <div class="main-container">
        <div class="card">
            <h2>数字人预览</h2>
            <div class="video-container">
                <video id="video" autoplay playsinline></video>
            </div>
            <div class="button-group">
                <button id="start" class="btn-primary">开始连接</button>
                <button id="stop" class="btn-danger" style="display: none;">断开连接</button>
            </div>

            <h3>文本/语音对话</h3>
            <div class="form-group" style="border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 16px 0; margin-top:10px;">
                <div class="switch-container">
                    <label for="rag-mode-speak-switch">RAG 模式驱动</label>
                    <label class="switch">
                        <input type="checkbox" id="rag-mode-speak-switch">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label for="kb-speak-select">使用知识库</label>
                    <select id="kb-speak-select">
                        <option value="">无</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <textarea id="human-text" placeholder="输入文本，让虚拟人说话..."></textarea>
                <button id="send-human-text" class="btn-secondary">发送文本并朗读</button>
            </div>
            <div class="button-group">
                <button id="start-record" class="btn-secondary">语音对话</button>
                <button id="stop-record" class="btn-danger" style="display: none;">停止录音</button>
            </div>
        </div>

        <div class="card">
            <h2>RAG 知识库交互</h2>
            
            <div class="form-group">
                <label for="chat-input">聊天输入 (不驱动数字人)</label>
                <textarea id="chat-input" placeholder="在此输入您的问题进行测试..."></textarea>
                <button id="send-chat" class="btn-primary">发送查询</button>
            </div>
             <div class="form-group">
                <label for="chat-output">模型响应</label>
                <div id="chat-output"></div>
            </div>

            <h3>数字人管理</h3>
            <div class="form-group">
                <label for="avatar-select">当前数字人</label>
                <div style="display: flex; gap: 10px;">
                    <select id="avatar-select" style="flex-grow: 1;">
                        <option value="">选择数字人</option>
                    </select>
                    <button id="avatar-switch" class="btn-primary">切换数字人</button>
                </div>
                <small id="avatar-status" style="margin-top: 5px; display: block;"></small>
            </div>
            <div class="form-group">
                <label for="avatar-file">上传数字人素材</label>
                <input type="file" id="avatar-file" accept=".mp4,.mkv,.flv,.avi,.mov,.jpg,.jpeg,.png">
                <label for="avatar-id" style="margin-top:10px;">数字人ID (可选，自动生成)</label>
                <input type="text" id="avatar-id" placeholder="如：xiaoli0001 (1-16位拼音+1-4位数字)">
                <button id="avatar-upload" class="btn-secondary" style="margin-top:10px;">创建数字人</button>
            </div>
            <div class="form-group">
                <label for="avatar-delete">删除数字人</label>
                <div style="display: flex; gap: 10px;">
                    <select id="avatar-delete-select" style="flex-grow: 1;">
                        <option value="">选择要删除的数字人</option>
                    </select>
                    <button id="avatar-delete" class="btn-danger">删除</button>
                </div>
            </div>

            <h3>FishTTS 声音克隆</h3>
            <div class="form-group">
                <label for="fishtts-voice-list">可用克隆音源 (用于驱动数字人)</label>
                <div style="display: flex; gap: 10px;">
                    <select id="fishtts-voice-list" style="flex-grow: 1;">
                        <option value="">使用默认音色</option>
                    </select>
                    <button id="delete-fishtts-voice" class="btn-danger">删除</button>
                </div>
                <small id="fishtts-status" style="margin-top: 5px; display: block;"></small>
            </div>
            <div class="form-group">
                <label for="fishtts-voice-name">新音源名称</label>
                <input type="text" id="fishtts-voice-name" placeholder="3-20位英文/数字">
                <label for="fishtts-audio-file" style="margin-top:10px;">上传音频 (WAV/MP3/FLAC, 最大40秒)</label>
                <input type="file" id="fishtts-audio-file" accept="audio/*">
                <button id="upload-fishtts-voice" class="btn-secondary" style="margin-top:10px;">上传新音源</button>
            </div>
            <h3>知识库管理</h3>
            <div class="form-group">
                <label for="kb-select">当前知识库 (全局)</label>
                <div style="display: flex; gap: 10px;">
                    <select id="kb-select" style="flex-grow: 1;">
                        <option value="">无</option>
                    </select>
                    <button id="delete-kb" class="btn-danger">删除</button>
                </div>
            </div>
            <div class="form-group">
                <label for="kb-name">新建知识库</label>
                <input type="text" id="kb-name" placeholder="输入知识库名称 (3-20位英文/数字)">
                <input type="file" id="kb-file">
                <button id="create-kb" class="btn-secondary">创建并上传</button>
            </div>

            <h3>RAG 设置</h3>
            <div class="switch-container">
                <label for="rag-mode-switch">RAG 模式 (全局)</label>
                <label class="switch">
                    <input type="checkbox" id="rag-mode-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="form-group">
                <label for="system-prompt">系统提示词</label>
                <textarea id="system-prompt"></textarea>
                <button id="update-prompt" class="btn-secondary">更新提示词</button>
            </div>
            <div id="status-bar" class="status-bar" style="display: none;"></div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM 元素
        const dom = {
            // 媒体元素
            video: document.getElementById('video'),
            audio: document.getElementById('audio'),

            sessionIdInput: document.getElementById('sessionid'),
            startConnBtn: document.getElementById('start'),
            stopConnBtn: document.getElementById('stop'),
            
            // 左侧交互
            sendHumanTextBtn: document.getElementById('send-human-text'),
            humanTextInput: document.getElementById('human-text'),
            startRecordBtn: document.getElementById('start-record'),
            stopRecordBtn: document.getElementById('stop-record'),
            ragModeSpeakSwitch: document.getElementById('rag-mode-speak-switch'),
            kbSpeakSelect: document.getElementById('kb-speak-select'),

            // 右侧交互与配置
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat'),
            chatOutput: document.getElementById('chat-output'),
            ragModeSwitch: document.getElementById('rag-mode-switch'),
            systemPrompt: document.getElementById('system-prompt'),
            updatePromptBtn: document.getElementById('update-prompt'),
            kbSelect: document.getElementById('kb-select'),
            deleteKbBtn: document.getElementById('delete-kb'),
            kbNameInput: document.getElementById('kb-name'),
            kbFileInput: document.getElementById('kb-file'),
            createKbBtn: document.getElementById('create-kb'),

            // ★★★ 新增: 数字人 DOM 元素 ★★★
            avatarSelect: document.getElementById('avatar-select'),
            avatarSwitch: document.getElementById('avatar-switch'),
            avatarStatus: document.getElementById('avatar-status'),
            avatarFile: document.getElementById('avatar-file'),
            avatarId: document.getElementById('avatar-id'),
            avatarUpload: document.getElementById('avatar-upload'),
            avatarDeleteSelect: document.getElementById('avatar-delete-select'),
            avatarDelete: document.getElementById('avatar-delete'),

            // ★★★ 新增: FishTTS DOM 元素 ★★★
            fishttsVoiceList: document.getElementById('fishtts-voice-list'),
            fishttsStatus: document.getElementById('fishtts-status'),
            deleteFishttsVoiceBtn: document.getElementById('delete-fishtts-voice'),
            fishttsVoiceNameInput: document.getElementById('fishtts-voice-name'),
            fishttsAudioFileInput: document.getElementById('fishtts-audio-file'),
            uploadFishttsVoiceBtn: document.getElementById('upload-fishtts-voice'),

            statusBar: document.getElementById('status-bar'),
            toast: document.getElementById('toast'),
        };
        
        // ★★★ 新增: 定义需要统一禁用的关键控件 ★★★
        const criticalControls = [
            dom.startConnBtn, dom.stopConnBtn,
            dom.sendHumanTextBtn, dom.startRecordBtn, dom.stopRecordBtn,
            dom.sendChatBtn,
            dom.avatarSwitch, dom.avatarUpload, dom.avatarDelete,
            dom.avatarFile, dom.avatarId,
            dom.uploadFishttsVoiceBtn, dom.deleteFishttsVoiceBtn,
            dom.createKbBtn, dom.deleteKbBtn
        ];

        // 状态变量
        let state = {
            sessionId: null,
            isRecording: false,
            mediaRecorder: null,
            audioChunks: [],
            heartbeatInterval: null,
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            isReconnecting: false,
        };
        
        // ★★★ 新增: 统一禁用/启用控件的辅助函数 ★★★
        function setControlsDisabled(disabled) {
            criticalControls.forEach(control => {
                if (control) control.disabled = disabled;
            });
        }

        // --- 工具函数 ---
        function showToast(message, type = 'success') {
            dom.toast.textContent = message;
            dom.toast.className = `toast show ${type}`;
            setTimeout(() => {
                dom.toast.className = 'toast';
            }, 3000);
        }

        function updateStatus(message, isLoading = false) {
            if (message) {
                dom.statusBar.style.display = 'block';
                dom.statusBar.innerHTML = isLoading 
                    ? `<div class="spinner"></div> ${message}`
                    : message;
            } else {
                dom.statusBar.style.display = 'none';
            }
        }

        // --- API 调用 ---
        const api = {
            async fetch(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({error: '未知错误'}));
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    if (options.method === 'DELETE' || response.status === 204) {
                        return response;
                    }
                    return response;
                } catch (error) {
                    showToast(`请求失败: ${error.message}`, 'error');
                    console.error('API Error:', error);
                    throw error;
                }
            },
            
            // ★★★ 修复: 区分知识库和数字人的任务状态查询API ★★★
            getConfig: () => api.fetch('/config/get').then(res => res.json()),
            getKbList: () => api.fetch('/kb/list').then(res => res.json()),
            switchKb: (name) => api.fetch(`/kb/switch/${name}`, { method: 'POST' }),
            deleteKb: (name) => api.fetch(`/kb/delete/${name}`, { method: 'DELETE' }),
            createKb: (formData) => api.fetch('/kb/create', { method: 'POST', body: formData }),
            getKbTaskStatus: (taskId) => api.fetch(`/kb/status/${taskId}`).then(res => res.json()), // 知识库专用
            updatePrompt: (prompt) => api.fetch('/config/prompt', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({prompt}) }),
            setRagMode: (use_rag) => api.fetch('/config/rag_mode', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({use_rag}) }),
            ragChat: (query) => api.fetch('/rag/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({query}) }),
            sendHumanText: (payload) => api.fetch('/human', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }),
            sendHumanAudio: (formData) => api.fetch('/audio_chat', { method: 'POST', body: formData }),
            interruptTalk: (sessionId) => api.fetch('/interrupt_talk', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sessionid: sessionId }) }),

            sessionHeartbeat: (sessionId) => api.fetch('/session/heartbeat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sessionid: Number(sessionId) }) }),
            reconnect: (payload) => api.fetch('/reconnect', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }),

            getAvatars: (page = 1, pageSize = 20) => api.fetch(`/api/avatars?page=${page}&page_size=${pageSize}`).then(res => res.json()),
            getAvatarDetail: (id) => api.fetch(`/api/avatars/${id}`).then(res => res.json()),
            createAvatar: (formData) => api.fetch('/api/avatars', { method: 'POST', body: formData }).then(res => res.json()),
            deleteAvatar: (id) => api.fetch(`/api/avatars/${id}`, { method: 'DELETE' }),
            switchAvatar: (sessionId, avatarId) => api.fetch(`/api/sessions/${sessionId}/avatar`, { 
                method: 'PATCH', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ avatar_id: avatarId }) 
            }).then(res => res.json()),
            getAvatarTaskStatus: (jobId) => api.fetch(`/api/avatars/tasks/${jobId}`).then(res => res.json()), // 数字人专用

            getFishttsVoices: () => api.fetch('/fishtts/voices').then(res => res.json()),
            uploadFishttsVoice: (formData) => api.fetch('/fishtts/voices', { method: 'POST', body: formData }).then(res => res.json()),
            deleteFishttsVoice: (name) => api.fetch(`/fishtts/voices/${name}`, { method: 'DELETE' }),
        };

        // --- FishTTS 核心功能函数 ---
        async function loadFishttsVoices() {
            try {
                const data = await api.getFishttsVoices();
                const voiceList = dom.fishttsVoiceList;
                voiceList.innerHTML = '<option value="">使用默认音色</option>';
                if (data.voices && data.voices.length > 0) {
                    data.voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice;
                        option.textContent = voice;
                        voiceList.appendChild(option);
                    });
                    dom.fishttsStatus.textContent = `仓库中有 ${data.voices.length} 个音源。`;
                } else {
                    dom.fishttsStatus.textContent = '音源仓库为空，将使用默认音色。';
                }
            } catch (error) {
                console.error("加载FishTTS音源失败:", error);
                dom.fishttsStatus.textContent = '加载音源列表失败。';
            }
        }

        async function handleUploadFishttsVoice() {
            const voiceName = dom.fishttsVoiceNameInput.value.trim();
            const file = dom.fishttsAudioFileInput.files[0];
            if (!voiceName.match(/^[a-zA-Z0-9_]{3,20}$/)) {
                showToast("名称不合法 (3-20位英文/数字/下划线)", 'error');
                return;
            }
            if (!file) {
                showToast("请选择一个音频文件", 'error');
                return;
            }
            const formData = new FormData();
            formData.append('voice_name', voiceName);
            formData.append('audio_file', file);
            updateStatus('正在上传并验证音源...', true);
            try {
                const data = await api.uploadFishttsVoice(formData);
                showToast(`音源 ${data.voice_name} 上传成功!`, 'success');
                dom.fishttsVoiceNameInput.value = '';
                dom.fishttsAudioFileInput.value = '';
                await loadFishttsVoices();
            } catch (e) {
            } finally {
                updateStatus(null);
            }
        }

        async function handleDeleteFishttsVoice() {
            const selectedVoice = dom.fishttsVoiceList.value;
            if (!selectedVoice) {
                showToast("请先选择一个要删除的音源", 'error');
                return;
            }
            if (confirm(`确定要删除音源 "${selectedVoice}" 吗？此操作不可恢复。`)) {
                try {
                    await api.deleteFishttsVoice(selectedVoice);
                    showToast(`音源 ${selectedVoice} 已删除`);
                    await loadFishttsVoices();
                } catch (e) {
                }
            }
        }

        // --- 数字人核心功能函数 ---
        async function loadAvatars() {
            try {
                const data = await api.getAvatars();
                const avatarSelect = dom.avatarSelect;
                const avatarDeleteSelect = dom.avatarDeleteSelect;
                avatarSelect.innerHTML = '<option value="">选择数字人</option>';
                avatarDeleteSelect.innerHTML = '<option value="">选择要删除的数字人</option>';
                if (data.avatars && data.avatars.length > 0) {
                    data.avatars.forEach(avatar => {
                        const selectOption = document.createElement('option');
                        selectOption.value = avatar.avatar_id;
                        selectOption.textContent = `${avatar.avatar_id} (${avatar.frames}帧)`;
                        avatarSelect.appendChild(selectOption);
                        const deleteOption = document.createElement('option');
                        deleteOption.value = avatar.avatar_id;
                        deleteOption.textContent = `${avatar.avatar_id} (${avatar.frames}帧)`;
                        avatarDeleteSelect.appendChild(deleteOption);
                    });
                    dom.avatarStatus.textContent = `共有 ${data.total} 个数字人。`;
                } else {
                    dom.avatarStatus.textContent = '暂无数字人，请先创建。';
                }
            } catch (error) {
                console.error("加载数字人列表失败:", error);
                dom.avatarStatus.textContent = '加载数字人列表失败。';
            }
        }
        
        // ★★★ 新增: 数字人素材文件验证函数 ★★★
        function validateAvatarFile() {
            const file = dom.avatarFile.files[0];
            if (!file) {
                return false;
            }

            const MAX_VIDEO_SIZE_MB = 50;
            const MAX_IMAGE_SIZE_MB = 10;
            const videoExtensions = ['.mp4', '.mkv', '.flv', '.avi', '.mov'];
            const imageExtensions = ['.jpg', '.jpeg', '.png'];
            
            const fileName = file.name.toLowerCase();
            const fileExtension = '.' + fileName.split('.').pop();
            const fileSizeMB = file.size / 1024 / 1024;

            const isVideo = videoExtensions.includes(fileExtension);
            const isImage = imageExtensions.includes(fileExtension);

            if (!isVideo && !isImage) {
                showToast('文件格式不支持。请上传指定的视频或图片格式。', 'error');
                dom.avatarFile.value = ''; // 重置文件输入
                return false;
            }

            if (isVideo && fileSizeMB > MAX_VIDEO_SIZE_MB) {
                showToast(`视频文件过大 (${fileSizeMB.toFixed(2)}MB)，请不要超过 ${MAX_VIDEO_SIZE_MB}MB。`, 'error');
                dom.avatarFile.value = '';
                return false;
            }

            if (isImage && fileSizeMB > MAX_IMAGE_SIZE_MB) {
                showToast(`图片文件过大 (${fileSizeMB.toFixed(2)}MB)，请不要超过 ${MAX_IMAGE_SIZE_MB}MB。`, 'error');
                dom.avatarFile.value = '';
                return false;
            }

            return true;
        }

        // ★★★ 修改: 创建数字人函数，增加任务互斥逻辑 ★★★
        async function handleCreateAvatar() {
            const file = dom.avatarFile.files[0];
            const avatarId = dom.avatarId.value.trim();

            if (!file) {
                showToast("请选择一个文件", 'error');
                return;
            }

            if (avatarId && !avatarId.match(/^[a-z]{1,16}\d{1,4}$/)) {
                showToast("数字人ID格式不正确，应为1-16位拼音+1-4位数字，如：xiaoli0001", 'error');
                return;
            }
            
            setControlsDisabled(true);
            updateStatus('正在创建数字人，请稍候...', true);

            const formData = new FormData();
            formData.append('file', file);
            if (avatarId) {
                formData.append('avatar_id', avatarId);
            }

            try {
                const result = await api.createAvatar(formData);
                showToast(`数字人创建任务已提交，任务ID: ${result.job_id}`, 'success');
                dom.avatarFile.value = '';
                dom.avatarId.value = '';
                pollAvatarTaskStatus(result.job_id, result.avatar_id);
            } catch (e) {
                setControlsDisabled(false);
                updateStatus(null);
            }
        }
        
        // ★★★ 修改: 轮询函数现在负责恢复控件 ★★★
        async function pollAvatarTaskStatus(jobId, avatarId) {
            const maxAttempts = 60;
            let attempts = 0;
            updateStatus(`数字人 ${avatarId} 创建中... (任务ID: ${jobId})`, true);

            const poll = async () => {
                try {
                    const taskInfo = await api.getAvatarTaskStatus(jobId);
                    
                    if (taskInfo.status === 'SUCCEEDED') {
                        showToast(`数字人 ${avatarId} 创建成功！`, 'success');
                        await loadAvatars();
                        setControlsDisabled(false);
                        updateStatus(null);
                        return;
                    } else if (taskInfo.status === 'FAILED') {
                        showToast(`数字人 ${avatarId} 创建失败: ${taskInfo.stderr_tail || '未知错误'}`, 'error');
                        setControlsDisabled(false);
                        updateStatus(null);
                        return;
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    } else {
                        showToast(`数字人 ${avatarId} 创建超时，请稍后检查状态`, 'error');
                        setControlsDisabled(false);
                        updateStatus(null);
                    }
                } catch (error) {
                    console.error("轮询任务状态失败:", error);
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 5000);
                    } else {
                        showToast(`轮询任务状态失败，请手动检查。`, 'error');
                        setControlsDisabled(false);
                        updateStatus(null);
                    }
                }
            };
            poll();
        }

        async function handleSwitchAvatar() {
            const selectedAvatar = dom.avatarSelect.value;
            const sessionId = state.sessionId;
            if (!selectedAvatar) {
                showToast("请先选择一个数字人", 'error');
                return;
            }
            if (!sessionId) {
                showToast("请先建立WebRTC连接", 'error');
                return;
            }
            try {
                await api.fetch('/interrupt_talk', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionid: sessionId })
                });
                const result = await api.switchAvatar(sessionId, selectedAvatar);
                if (result.error && result.error.includes("会话不存在")) {
                    showToast('会话失效，尝试重连...', 'warning');
                    try {
                        await api.fetch('/reconnect', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ sessionid: sessionId })
                        });
                        showToast('已重连，请再次点击“切换数字人”。', 'success');
                    } catch (re) {
                        showToast('重连失败，请重新建立连接。', 'error');
                    }
                    return;
                }
                showToast(`数字人切换成功: ${result.previous || '无'} -> ${result.current}`, 'success');
            } catch (e) {
                console.error(e);
            }
        }

        async function handleDeleteAvatar() {
            const selectedAvatar = dom.avatarDeleteSelect.value;
            if (!selectedAvatar) {
                showToast("请先选择一个要删除的数字人", 'error');
                return;
            }
            if (confirm(`确定要删除数字人 "${selectedAvatar}" 吗？此操作不可恢复。`)) {
                try {
                    await api.deleteAvatar(selectedAvatar);
                    showToast(`数字人 ${selectedAvatar} 已删除`);
                    await loadAvatars();
                } catch (e) {
                }
            }
        }
        
        // --- 核心功能 (部分修改) ---
        async function initializeRAG() {
            try {
                const [config, kbList] = await Promise.all([api.getConfig(), api.getKbList()]);
                dom.ragModeSwitch.checked = config.use_rag;
                dom.ragModeSpeakSwitch.checked = config.use_rag;
                dom.systemPrompt.value = config.system_prompt;
                const kbOptions = '<option value="">无</option>' + kbList.knowledge_bases.map(kb => `<option value="${kb}">${kb}</option>`).join('');
                dom.kbSelect.innerHTML = kbOptions;
                dom.kbSpeakSelect.innerHTML = kbOptions;
                if (config.current_kb) {
                    dom.kbSelect.value = config.current_kb;
                    dom.kbSpeakSelect.value = config.current_kb;
                }
            } catch (error) {
                console.error("初始化RAG配置失败:", error);
                showToast("无法加载RAG配置", 'error');
            }
        }
        
        async function handleCreateKb() {
            const kbName = dom.kbNameInput.value.trim();
            const file = dom.kbFileInput.files[0];
            if (!kbName.match(/^[a-zA-Z0-9]{3,20}$/)) {
                showToast("知识库名称不合法 (3-20位英文/数字)", 'error');
                return;
            }
            if (!file) {
                showToast("请选择要上传的文件", 'error');
                return;
            }
            const allowedExtensions = ['.pdf', '.docx', '.doc', '.pptx', '.ppt', '.txt', '.md'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                showToast('文件格式不支持。请上传 PDF, Word, PPT, 或 TXT/MD 文件。', 'error');
                dom.kbFileInput.value = '';
                return;
            }
            const formData = new FormData();
            formData.append('kb_name', kbName);
            formData.append('file', file);
            try {
                const response = await api.createKb(formData);
                const data = await response.json();
                showToast('文件上传成功，后台处理中...');
                pollKbTaskStatus(data.task_id); // ★★★ 修复: 调用重命名后的函数
            } catch(e) {}
        }

        // ★★★ 修复: 重命名函数避免冲突 ★★★
        function pollKbTaskStatus(taskId) {
            updateStatus(`任务 ${taskId}: 正在处理...`, true);
            const interval = setInterval(async () => {
                try {
                    const status = await api.getKbTaskStatus(taskId); // ★★★ 修复: 调用正确的API
                    updateStatus(`任务 ${taskId}: ${status.message}`, status.status === 'processing');
                    if (status.status === 'success') {
                        clearInterval(interval);
                        showToast(status.message, 'success');
                        await initializeRAG();
                        updateStatus(null);
                    } else if (status.status === 'failed') {
                        clearInterval(interval);
                        showToast(status.message, 'error');
                        updateStatus(null);
                    }
                } catch (e) {
                    clearInterval(interval);
                    updateStatus(null);
                }
            }, 3000);
        }
        
        async function handleRagChat() {
            const query = dom.chatInput.value.trim();
            if (!query) return;
            dom.chatOutput.textContent = '';
            dom.sendChatBtn.disabled = true;
            try {
                const response = await api.ragChat(query);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        try {
                            const jsonData = JSON.parse(line);
                            if (jsonData && jsonData.response) {
                                dom.chatOutput.textContent += jsonData.response;
                            }
                        } catch (e) {
                            console.warn("无法解析的JSON行:", line);
                        }
                    }
                }
                if (buffer.trim() !== '') {
                     try {
                        const jsonData = JSON.parse(buffer);
                        if (jsonData && jsonData.response) {
                            dom.chatOutput.textContent += jsonData.response;
                        }
                    } catch (e) {
                        console.warn("无法解析的JSON行 (buffer):", buffer);
                    }
                }
            } catch (e) {
                dom.chatOutput.textContent = `查询失败: ${e.message}`;
            } finally {
                dom.sendChatBtn.disabled = false;
            }
        }

        async function handleSendHumanText() {
            if (!state.sessionId) {
                showToast('请先连接数字人', 'error');
                return;
            }
            const text = dom.humanTextInput.value.trim();
            if (!text) return;
            await api.interruptTalk(state.sessionId).catch(e => console.error("打断请求失败:", e));
            const useRag = dom.ragModeSpeakSwitch.checked;
            const kbName = dom.kbSpeakSelect.value;
            const selectedFishttsVoice = dom.fishttsVoiceList.value;
            const payload = {
                sessionid: state.sessionId,
                text: text,
                interrupt: false,
                use_rag: useRag,
                kb_name: useRag ? kbName : null,
                type: 'chat',
                tts_options: {}
            };
            if (selectedFishttsVoice) {
                payload.tts_options.voice_clone_name = selectedFishttsVoice;
            }
            try {
                await api.sendHumanText(payload);
            } catch (e) {}
        }

        function connect() {
            dom.startConnBtn.disabled = true;
            dom.startConnBtn.textContent = '连接中...';
            window.start();
            if (pc) {
                pc.addEventListener('connectionstatechange', handleConnectionStateChange);
            }
            const interval = setInterval(() => {
                if (dom.sessionIdInput.value && dom.sessionIdInput.value !== "0") {
                    clearInterval(interval);
                    state.sessionId = dom.sessionIdInput.value;
                    showToast('连接成功！');
                    dom.startConnBtn.style.display = 'none';
                    dom.stopConnBtn.style.display = 'block';
                    if (state.heartbeatInterval) clearInterval(state.heartbeatInterval);
                    state.heartbeatInterval = setInterval(() => {
                        if (state.sessionId) {
                            api.sessionHeartbeat(state.sessionId).catch(e => console.error("心跳失败:", e));
                        }
                    }, 20000);
                }
            }, 500);
        }

        function disconnect() {
            if (state.heartbeatInterval) clearInterval(state.heartbeatInterval);
            state.heartbeatInterval = null;
            state.isReconnecting = false;
            if (window.stop) window.stop();
            state.sessionId = null;
            dom.sessionIdInput.value = '';
            showToast('已断开连接');
            dom.startConnBtn.style.display = 'block';
            dom.stopConnBtn.style.display = 'none';
            dom.startConnBtn.disabled = false;
            dom.startConnBtn.textContent = '开始连接';
        }

        async function tryReconnect() {
            if (!pc || !state.sessionId) return;
            console.log('尝试进行 ICE 重启...');
            const offer = await pc.createOffer({ iceRestart: true });
            await pc.setLocalDescription(offer);
            const res = await api.reconnect({
                sessionid: Number(state.sessionId),
                sdp: offer.sdp,
                type: offer.type
            });
            const ans = await res.json();
            await pc.setRemoteDescription({ type: ans.type, sdp: ans.sdp });
            console.log('ICE 重启 offer/answer交换完成');
        }

        async function handleDisconnect() {
            state.isReconnecting = true;
            state.reconnectAttempts = 0;
            while (state.reconnectAttempts < state.maxReconnectAttempts && state.isReconnecting) {
                state.reconnectAttempts++;
                showToast(`连接断开, 正在进行第 ${state.reconnectAttempts}/${state.maxReconnectAttempts} 次重连...`, 'error');
                try {
                    await tryReconnect();
                    await new Promise(r => setTimeout(r, 4000));
                    if (pc && pc.connectionState === 'connected') {
                        return;
                    }
                } catch (error) {
                    console.error(`重连尝试 ${state.reconnectAttempts} 失败:`, error);
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
            if (state.isReconnecting) {
                showToast('重连失败, 请手动连接。', 'error');
                disconnect();
            }
        }

        function handleConnectionStateChange() {
            if (!pc) return;
            console.log(`连接状态变更: ${pc.connectionState}`);
            switch (pc.connectionState) {
                case 'connected':
                    if (state.isReconnecting) {
                        showToast('WebRTC 连接已恢复', 'success');
                    }
                    state.isReconnecting = false;
                    state.reconnectAttempts = 0;
                    break;
                case 'disconnected':
                    if (!state.isReconnecting) {
                        handleDisconnect();
                    }
                    break;
                case 'failed':
                    showToast('连接彻底失败, 请手动重新连接。', 'error');
                    state.isReconnecting = false;
                    disconnect();
                    break;
            }
        }
        
        async function startRecording() {
            if (!state.sessionId) {
                showToast("请先连接数字人", "error");
                return;
            }
            await api.interruptTalk(state.sessionId).catch(e => console.error("打断请求失败:", e));
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                state.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
                    const useRag = dom.ragModeSpeakSwitch.checked;
                    const kbName = dom.kbSpeakSelect.value;
                    const selectedFishttsVoice = dom.fishttsVoiceList.value;
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'recording.wav');
                    formData.append('sessionid', state.sessionId);
                    formData.append('use_rag', String(useRag));
                    if (useRag) {
                        formData.append('kb_name', kbName);
                    }
                    const ttsOptions = {};
                    if (selectedFishttsVoice) {
                        ttsOptions.voice_clone_name = selectedFishttsVoice;
                    }
                    formData.append('tts_options', JSON.stringify(ttsOptions));
                    try {
                        await api.sendHumanAudio(formData);
                        showToast('语音已发送处理');
                    } catch(e) {}
                    dom.stopRecordBtn.style.display = 'none';
                    dom.startRecordBtn.style.display = 'block';
                    state.isRecording = false;
                };
                state.mediaRecorder.start();
                state.isRecording = true;
                dom.startRecordBtn.style.display = 'none';
                dom.stopRecordBtn.style.display = 'block';
            } catch (e) {
                showToast('无法访问麦克风', 'error');
            }
        }
        
        function stopRecording() {
            if (state.mediaRecorder && state.isRecording) {
                state.mediaRecorder.stop();
            }
        }

        // --- 事件监听 ---
        dom.startConnBtn.addEventListener('click', connect);
        dom.stopConnBtn.addEventListener('click', disconnect);
        dom.sendHumanTextBtn.addEventListener('click', handleSendHumanText);
        dom.startRecordBtn.addEventListener('click', startRecording);
        dom.stopRecordBtn.addEventListener('click', stopRecording);

        dom.sendChatBtn.addEventListener('click', handleRagChat);
        dom.createKbBtn.addEventListener('click', handleCreateKb);
        dom.updatePromptBtn.addEventListener('click', async () => { try { await api.updatePrompt(dom.systemPrompt.value); showToast('提示词更新成功'); } catch(e){} });
        
        dom.kbFileInput.addEventListener('change', () => {
            const file = dom.kbFileInput.files[0];
            if (!file) return;
            const allowedExtensions = ['.pdf', '.docx', '.doc', '.pptx', '.ppt', '.txt', '.md'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                showToast('文件格式不支持。请上传 PDF, Word, PPT, 或 TXT/MD 文件。', 'error');
                dom.kbFileInput.value = '';
            }
        });

        // ★★★ 新增: 数字人素材上传前的验证 ★★★
        dom.avatarFile.addEventListener('change', validateAvatarFile);

        function syncControls(source, value) {
            if (source === 'ragSwitch') {
                dom.ragModeSpeakSwitch.checked = value;
                dom.ragModeSwitch.checked = value;
            } else if (source === 'kbSelect') {
                dom.kbSpeakSelect.value = value;
                dom.kbSelect.value = value;
            }
        }
        
        dom.ragModeSwitch.addEventListener('change', async (e) => { 
            const isChecked = e.target.checked;
            syncControls('ragSwitch', isChecked);
            try { await api.setRagMode(isChecked); showToast(`RAG模式已${isChecked ? '开启' : '关闭'}`); } catch(e){} 
        });
        dom.ragModeSpeakSwitch.addEventListener('change', (e) => {
             const isChecked = e.target.checked;
             syncControls('ragSwitch', isChecked);
             dom.ragModeSwitch.dispatchEvent(new Event('change'));
        });

        dom.kbSelect.addEventListener('change', async (e) => {
              const selectedValue = e.target.value;
              syncControls('kbSelect', selectedValue);
              if (!selectedValue && selectedValue !== "") return;
              try { await api.switchKb(selectedValue); showToast(selectedValue ? `知识库已切换为 ${selectedValue}` : '已取消使用知识库'); } catch(e){}
        });
        dom.kbSpeakSelect.addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            syncControls('kbSelect', selectedValue);
            dom.kbSelect.dispatchEvent(new Event('change'));
        });
        
        dom.deleteKbBtn.addEventListener('click', async () => {
            const selectedKb = dom.kbSelect.value;
            if (!selectedKb) { showToast('请选择一个知识库', 'error'); return; }
            if (confirm(`确定要删除知识库 "${selectedKb}" 吗？此操作不可恢复。`)) {
                try {
                    await api.deleteKb(selectedKb);
                    showToast(`知识库 ${selectedKb} 已删除`);
                    await initializeRAG();
                } catch(e){}
            }
        });

        dom.uploadFishttsVoiceBtn.addEventListener('click', handleUploadFishttsVoice);
        dom.deleteFishttsVoiceBtn.addEventListener('click', handleDeleteFishttsVoice);
        dom.avatarUpload.addEventListener('click', handleCreateAvatar);
        dom.avatarSwitch.addEventListener('click', handleSwitchAvatar);
        dom.avatarDelete.addEventListener('click', handleDeleteAvatar);

        // --- 页面初始化 ---
        initializeRAG();
        loadFishttsVoices();
        loadAvatars();
    });
</script>
</body>
</html>